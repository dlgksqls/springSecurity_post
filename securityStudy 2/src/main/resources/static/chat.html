<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Spring Boot WebSocket Chat</title>
    </head>
    <body>
        <h2>Spring Boot WebSocket Chat</h2>

        <div>
            <input type="text" id="username" placeholder="사용자 이름" />
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
        </div>

        <div>
            <input type="text" id="message" placeholder="메시지 입력" />
            <button onclick="sendMessage()">send</button>
        </div>

        <div id="chatArea"></div>

        <script src="/webjars/sockjs-client/1.5.1/sockjs.js"></script>
        <script src="/webjars/stomp-websocket/2.3.4/stomp.js"></script>

        <script>
            var stompClient = null;

            function connect(){
                console.log('connect() called');
                var socket = new SockJS("/ws-stomp");
                stompClient = Stomp.over(socket);

                stompClient.connect({}, function (frame){
                    console.log('Connected: ' + frame);

                    stompClient.subscribe('/topic/public', function (chatMessage){
                        showMessage(JSON.parse(chatMessage.body));
                    });

                    let username = document.getElementById('username').value.trim();
                    if(username){
                        stompClient.send("/app/chat.newUser", {}, JSON.stringify({
                            sender: username,
                            content: '',
                            type: 'ENTER'
                        }));
                    }
                }, function(error) {
                    console.log('STOMP error', error);
                });
            }



            function disconnect(){
                if (stompClient != null){
                    stompClient.disconnect();
                }
            }

            function sendMessage(){
                var messageInput = document.getElementById("message");
                var messageContent = messageInput.value.trim();
                var username = document.getElementById('username').value.trim();

                if (messageContent && stompClient){
                    var chatMessage = {
                        sender: username,
                        content: messageContent,
                        type: 'CHAT'
                    };
                    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                    messageInput.value = '';
                }
            }

            function showMessage(message){
                var chatArea = document.getElementById('chatArea');
                var messageElement = document.createElement('div');

                if (message.type == 'ENTER'){
                    messageElement.innerHTML = "<strong>" + message.content + "</strong>";
                }
                else if (message.type == 'CHAT'){
                    messageElement.innerHTML = "<strong>" + message.sender + ":</strong>" + message.content;
                }
                else if (message.type == 'LEAVE'){
                    messageElement.innerHTML = "<strong>" + message.sender + "님이 퇴장했습니다.</strong>";
                }

                chatArea.appendChild(messageElement);
            }
        </script>
    </body>
</html>